name: ðŸš€ WordPress Multi-Site Deployment

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
        - staging
        - production

env:
  NODE_VERSION: 18
  PHP_VERSION: 8.2

jobs:
  # ========================================
  # SECURITY AND VALIDATION
  # ========================================
  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ” Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: ðŸ“Š Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
        
    - name: ðŸ”Ž Detect secrets
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        extra_args: --debug --only-verified

  # ========================================
  # BUILD AND TEST
  # ========================================
  build-test:
    name: ðŸ”¨ Build & Test
    runs-on: ubuntu-latest
    needs: security-scan
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: ðŸ” Validate Docker Compose
      run: |
        docker-compose config --quiet
        
    - name: ðŸ—ï¸ Build Docker images
      run: |
        docker-compose build --no-cache
        
    - name: ðŸ§ª Test container startup
      run: |
        docker-compose up -d
        sleep 30
        docker-compose ps
        
    - name: ðŸ©º Health check
      run: |
        # Check if containers are healthy
        ./scripts/health-check.sh
        
    - name: ðŸ§¹ Cleanup
      if: always()
      run: |
        docker-compose down -v
        docker system prune -f

  # ========================================
  # STAGING DEPLOYMENT
  # ========================================
  deploy-staging:
    name: ðŸŽ­ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [security-scan, build-test]
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'staging'
    environment: staging
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ” Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.STAGING_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.STAGING_HOST }} >> ~/.ssh/known_hosts
        
    - name: ðŸ“¤ Deploy to staging server
      run: |
        rsync -avz --exclude-from='.gitignore' \
          --exclude='.git' \
          --exclude='DB/*.sql' \
          ./ ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }}:${{ secrets.STAGING_PATH }}/
          
    - name: ðŸ”§ Configure staging environment
      run: |
        ssh ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} << 'EOF'
          cd ${{ secrets.STAGING_PATH }}
          echo "${{ secrets.STAGING_ENV }}" > .env
          chmod +x scripts/*.sh
          ./scripts/deploy.sh start staging
        EOF
        
    - name: ðŸ§ª Run staging tests
      run: |
        ssh ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} << 'EOF'
          cd ${{ secrets.STAGING_PATH }}
          ./scripts/health-check.sh
        EOF

  # ========================================
  # PRODUCTION DEPLOYMENT
  # ========================================
  deploy-production:
    name: ðŸŒŸ Deploy to Production
    runs-on: ubuntu-latest
    needs: [security-scan, build-test]
    if: github.ref == 'refs/heads/main' && github.event.inputs.environment != 'staging'
    environment: production
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ” Configure SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.PRODUCTION_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.PRODUCTION_HOST }} >> ~/.ssh/known_hosts
        
    - name: ðŸ’¾ Backup production
      run: |
        ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'EOF'
          cd ${{ secrets.PRODUCTION_PATH }}
          if [ -f "docker-compose.yml" ]; then
            ./scripts/backup.sh emergency
          fi
        EOF
        
    - name: ðŸ“¤ Deploy to production server
      run: |
        rsync -avz --exclude-from='.gitignore' \
          --exclude='.git' \
          --exclude='DB/*.sql' \
          ./ ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }}:${{ secrets.PRODUCTION_PATH }}/
          
    - name: ðŸ”§ Configure production environment
      run: |
        ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'EOF'
          cd ${{ secrets.PRODUCTION_PATH }}
          echo "${{ secrets.PRODUCTION_ENV }}" > .env
          chmod +x scripts/*.sh
          ./scripts/deploy.sh start production
        EOF
        
    - name: ðŸ“Š Import databases (if needed)
      run: |
        ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'EOF'
          cd ${{ secrets.PRODUCTION_PATH }}
          if [ -d "DB" ] && [ "$(ls -A DB/*.sql 2>/dev/null)" ]; then
            ./scripts/import-database.sh import
          fi
        EOF
        
    - name: ðŸ”’ Setup SSL certificates
      run: |
        ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'EOF'
          cd ${{ secrets.PRODUCTION_PATH }}
          ./scripts/deploy.sh ssl
        EOF
        
    - name: ðŸ©º Production health check
      run: |
        ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'EOF'
          cd ${{ secrets.PRODUCTION_PATH }}
          ./scripts/health-check.sh
        EOF
        
    - name: ðŸ”„ Rollback on failure
      if: failure()
      run: |
        ssh ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'EOF'
          cd ${{ secrets.PRODUCTION_PATH }}
          ./scripts/rollback.sh
        EOF

  # ========================================
  # POST-DEPLOYMENT
  # ========================================
  post-deployment:
    name: ðŸ“ˆ Post-Deployment Tasks
    runs-on: ubuntu-latest
    needs: deploy-production
    if: success()
    
    steps:
    - name: ðŸ“Š Update deployment status
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.repos.createDeploymentStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            deployment_id: context.payload.deployment?.id || 0,
            state: 'success',
            description: 'Deployment completed successfully'
          })
          
    - name: ðŸ“¨ Notify Slack
      uses: 8398a7/action-slack@v3
      if: always()
      with:
        status: ${{ job.status }}
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        fields: repo,message,commit,author,action,eventName,ref,workflow
        
    - name: ðŸ“§ Notify email on failure
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: 'ðŸš¨ WordPress Deployment Failed - ${{ github.repository }}'
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: 'GitHub Actions <noreply@github.com>'
        body: |
          Deployment failed for commit ${{ github.sha }}
          
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref }}
          Author: ${{ github.actor }}
          
          Check the workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}