name: ðŸ†• Add New Website

on:
  workflow_dispatch:
    inputs:
      website_name:
        description: 'Website name (e.g., newsite)'
        required: true
        type: string
      domain:
        description: 'Domain name (e.g., newsite.com)'
        required: true
        type: string
      website_type:
        description: 'Website type'
        required: true
        default: 'wordpress'
        type: choice
        options:
        - wordpress
        - static
      database_name:
        description: 'Database name (auto-generated if empty)'
        required: false
        type: string
      ssl_enabled:
        description: 'Enable SSL certificate'
        required: true
        default: true
        type: boolean

jobs:
  add-website:
    name: ðŸ—ï¸ Add New Website
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ”§ Setup Git
      run: |
        git config --global user.name 'GitHub Actions Bot'
        git config --global user.email 'actions@github.com'
        
    - name: ðŸŒ¿ Create feature branch
      run: |
        BRANCH_NAME="feature/add-${{ inputs.website_name }}-$(date +%s)"
        echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
        git checkout -b $BRANCH_NAME
        
    - name: ðŸ“ Create website directory structure
      run: |
        WEBSITE_NAME="${{ inputs.website_name }}"
        DOMAIN="${{ inputs.domain }}"
        WEBSITE_TYPE="${{ inputs.website_type }}"
        
        if [ "$WEBSITE_TYPE" = "wordpress" ]; then
          mkdir -p "${WEBSITE_NAME}.${DOMAIN}/public_html"
          
          # Create basic WordPress structure
          cat > "${WEBSITE_NAME}.${DOMAIN}/public_html/index.php" << 'EOF'
        <?php
        /**
         * WordPress Bootstrap File
         * Auto-generated by GitHub Actions
         */
        
        /** Sets up the WordPress Environment. */
        require __DIR__ . '/wp-blog-header.php';
        EOF
          
          cat > "${WEBSITE_NAME}.${DOMAIN}/public_html/wp-config.php" << 'EOF'
        <?php
        /**
         * WordPress Configuration File
         * Auto-generated for containerized deployment
         */
        
        // Database settings from environment
        define('DB_NAME', getenv('WORDPRESS_DB_NAME'));
        define('DB_USER', getenv('WORDPRESS_DB_USER'));
        define('DB_PASSWORD', getenv('WORDPRESS_DB_PASSWORD'));
        define('DB_HOST', getenv('WORDPRESS_DB_HOST'));
        define('DB_CHARSET', 'utf8mb4');
        define('DB_COLLATE', '');
        
        // Security keys (will be replaced in production)
        define('AUTH_KEY',         'auto-generated-auth-key');
        define('SECURE_AUTH_KEY',  'auto-generated-secure-auth-key');
        define('LOGGED_IN_KEY',    'auto-generated-logged-in-key');
        define('NONCE_KEY',        'auto-generated-nonce-key');
        define('AUTH_SALT',        'auto-generated-auth-salt');
        define('SECURE_AUTH_SALT', 'auto-generated-secure-auth-salt');
        define('LOGGED_IN_SALT',   'auto-generated-logged-in-salt');
        define('NONCE_SALT',       'auto-generated-nonce-salt');
        
        // WordPress table prefix
        $table_prefix = getenv('WORDPRESS_TABLE_PREFIX') ?: 'wp_';
        
        // WordPress debugging
        define('WP_DEBUG', getenv('WP_DEBUG') === 'true');
        define('WP_DEBUG_LOG', true);
        define('WP_DEBUG_DISPLAY', false);
        
        // Cache settings
        define('WP_CACHE', getenv('WP_CACHE') === 'true');
        
        // WordPress absolute path
        if (!defined('ABSPATH')) {
            define('ABSPATH', __DIR__ . '/');
        }
        
        /** Sets up WordPress vars and included files. */
        require_once ABSPATH . 'wp-settings.php';
        EOF
        
        else
          # Static website
          mkdir -p "${WEBSITE_NAME}.${DOMAIN}/public_html"
          cat > "${WEBSITE_NAME}.${DOMAIN}/public_html/index.html" << EOF
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${DOMAIN}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; text-align: center; }
                .container { max-width: 800px; margin: 0 auto; }
                .header { background: #f4f4f4; padding: 20px; border-radius: 8px; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>Welcome to ${DOMAIN}</h1>
                    <p>Your website is now live!</p>
                    <p>This is a static website deployed via Docker containers.</p>
                </div>
                <p>Website added automatically on $(date)</p>
            </div>
        </body>
        </html>
        EOF
        fi
        
    - name: ðŸ³ Update Docker Compose configuration
      run: |
        WEBSITE_NAME="${{ inputs.website_name }}"
        DOMAIN="${{ inputs.domain }}"
        WEBSITE_TYPE="${{ inputs.website_type }}"
        DB_NAME="${{ inputs.database_name }}"
        
        if [ -z "$DB_NAME" ]; then
          DB_NAME="${WEBSITE_NAME}_wp"
        fi
        
        # Add to nginx dependencies
        sed -i "/depends_on:/a\\      - ${WEBSITE_NAME}" docker-compose.yml
        
        if [ "$WEBSITE_TYPE" = "wordpress" ]; then
          # Add WordPress service
          cat >> docker-compose.yml << EOF
        
          # ${DOMAIN} WordPress Site
          ${WEBSITE_NAME}:
            build:
              context: .
              dockerfile: ./dockerfiles/Dockerfile.wordpress
            container_name: ${WEBSITE_NAME}-wp
            environment:
              WORDPRESS_DB_HOST: mysql
              WORDPRESS_DB_NAME: \${${WEBSITE_NAME^^}_DB_NAME}
              WORDPRESS_DB_USER: \${${WEBSITE_NAME^^}_DB_USER}
              WORDPRESS_DB_PASSWORD: \${${WEBSITE_NAME^^}_DB_PASSWORD}
              WORDPRESS_TABLE_PREFIX: wp_
              WP_CACHE: "true"
              WP_DEBUG: "false"
            volumes:
              - ./${WEBSITE_NAME}.${DOMAIN}/public_html:/var/www/html
              - wp_${WEBSITE_NAME}:/var/www/html/wp-content/uploads
            depends_on:
              - mysql
              - redis
            restart: unless-stopped
            networks:
              - wp-network
        EOF
        
          # Add volume
          sed -i "/^volumes:/a\\  wp_${WEBSITE_NAME}:" docker-compose.yml
          
        else
          # Add static website service
          cat >> docker-compose.yml << EOF
        
          # ${DOMAIN} Static Site
          ${WEBSITE_NAME}:
            image: nginx:alpine
            container_name: ${WEBSITE_NAME}-static
            volumes:
              - ./${WEBSITE_NAME}.${DOMAIN}/public_html:/usr/share/nginx/html:ro
              - ./nginx/static-site.conf:/etc/nginx/conf.d/default.conf:ro
            restart: unless-stopped
            networks:
              - wp-network
        EOF
        fi
        
    - name: ðŸŒ Update Nginx configuration
      run: |
        WEBSITE_NAME="${{ inputs.website_name }}"
        DOMAIN="${{ inputs.domain }}"
        WEBSITE_TYPE="${{ inputs.website_type }}"
        
        # Add nginx configuration
        cat >> nginx/conf.d/default.conf << EOF
        
        # ${DOMAIN} ${WEBSITE_TYPE^} Site
        server {
            listen 80;
            server_name ${DOMAIN} www.${DOMAIN};
            
            location / {
                proxy_pass http://${WEBSITE_NAME}:80;
                proxy_set_header Host \$host;
                proxy_set_header X-Real-IP \$remote_addr;
                proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto \$scheme;
                proxy_connect_timeout 30s;
                proxy_send_timeout 30s;
                proxy_read_timeout 30s;
            }
            
            # Rate limiting
            limit_req zone=one burst=10 nodelay;
            limit_conn addr 10;
        }
        EOF
        
    - name: âš™ï¸ Update environment configuration
      run: |
        WEBSITE_NAME="${{ inputs.website_name }}"
        DOMAIN="${{ inputs.domain }}"
        WEBSITE_TYPE="${{ inputs.website_type }}"
        DB_NAME="${{ inputs.database_name }}"
        
        if [ -z "$DB_NAME" ]; then
          DB_NAME="${WEBSITE_NAME}_wp"
        fi
        
        if [ "$WEBSITE_TYPE" = "wordpress" ]; then
          # Add to .env.example
          cat >> .env.example << EOF
        
        # ${DOMAIN} Database
        ${WEBSITE_NAME^^}_DB_NAME=${DB_NAME}
        ${WEBSITE_NAME^^}_DB_USER=${WEBSITE_NAME}_user
        ${WEBSITE_NAME^^}_DB_PASSWORD=${WEBSITE_NAME}_secure_password
        EOF
        fi
        
    - name: ðŸ“ Create documentation
      run: |
        WEBSITE_NAME="${{ inputs.website_name }}"
        DOMAIN="${{ inputs.domain }}"
        WEBSITE_TYPE="${{ inputs.website_type }}"
        
        mkdir -p docs/websites
        
        cat > "docs/websites/${WEBSITE_NAME}.md" << EOF
        # ${DOMAIN} - ${WEBSITE_TYPE^} Website
        
        **Auto-generated on:** $(date)
        **Website Type:** ${WEBSITE_TYPE^}
        **Domain:** ${DOMAIN}
        **Container Name:** ${WEBSITE_NAME}-$([ "$WEBSITE_TYPE" = "wordpress" ] && echo "wp" || echo "static")
        
        ## Configuration
        
        ### Docker Service
        - **Service Name:** \`${WEBSITE_NAME}\`
        - **Container:** \`${WEBSITE_NAME}-$([ "$WEBSITE_TYPE" = "wordpress" ] && echo "wp" || echo "static")\`
        - **Port:** 80 (internal)
        - **Network:** wp-network
        
        $(if [ "$WEBSITE_TYPE" = "wordpress" ]; then
        cat << EOL
        ### Database
        - **Database Name:** \${${WEBSITE_NAME^^}_DB_NAME}
        - **Database User:** \${${WEBSITE_NAME^^}_DB_USER}
        - **Table Prefix:** wp_
        
        ### WordPress Configuration
        - **Config File:** \`${WEBSITE_NAME}.${DOMAIN}/public_html/wp-config.php\`
        - **Document Root:** \`${WEBSITE_NAME}.${DOMAIN}/public_html/\`
        - **Uploads Volume:** \`wp_${WEBSITE_NAME}\`
        EOL
        else
        cat << EOL
        ### Static Website
        - **Document Root:** \`${WEBSITE_NAME}.${DOMAIN}/public_html/\`
        - **Index File:** \`index.html\`
        EOL
        fi)
        
        ### Nginx Configuration
        - **Server Names:** ${DOMAIN}, www.${DOMAIN}
        - **Proxy Target:** http://${WEBSITE_NAME}:80
        - **Rate Limiting:** 10 requests/burst
        
        ## Deployment Steps
        
        1. **Environment Variables**
        $(if [ "$WEBSITE_TYPE" = "wordpress" ]; then
        cat << EOL
           Add to your \`.env\` file:
           \`\`\`
           ${WEBSITE_NAME^^}_DB_NAME=${WEBSITE_NAME}_wp
           ${WEBSITE_NAME^^}_DB_USER=${WEBSITE_NAME}_user
           ${WEBSITE_NAME^^}_DB_PASSWORD=secure_password_here
           \`\`\`
        EOL
        else
        echo "   No database configuration needed for static websites."
        fi)
        
        2. **DNS Configuration**
           Point these domains to your server IP:
           - ${DOMAIN}
           - www.${DOMAIN}
        
        3. **SSL Certificate**
           \`\`\`bash
           certbot certonly --standalone -d ${DOMAIN} -d www.${DOMAIN}
           \`\`\`
        
        4. **Deploy**
           \`\`\`bash
           docker-compose up -d ${WEBSITE_NAME}
           \`\`\`
        
        ## Health Check
        
        \`\`\`bash
        curl -I http://${DOMAIN}
        docker logs ${WEBSITE_NAME}-$([ "$WEBSITE_TYPE" = "wordpress" ] && echo "wp" || echo "static")
        \`\`\`
        
        ## Troubleshooting
        
        ### View Logs
        \`\`\`bash
        docker logs ${WEBSITE_NAME}-$([ "$WEBSITE_TYPE" = "wordpress" ] && echo "wp" || echo "static")
        \`\`\`
        
        ### Restart Container
        \`\`\`bash
        docker restart ${WEBSITE_NAME}-$([ "$WEBSITE_TYPE" = "wordpress" ] && echo "wp" || echo "static")
        \`\`\`
        
        ### Access Container
        \`\`\`bash
        docker exec -it ${WEBSITE_NAME}-$([ "$WEBSITE_TYPE" = "wordpress" ] && echo "wp" || echo "static") /bin/bash
        \`\`\`
        EOF
        
    - name: ðŸ“Š Update main README
      run: |
        WEBSITE_NAME="${{ inputs.website_name }}"
        DOMAIN="${{ inputs.domain }}"
        WEBSITE_TYPE="${{ inputs.website_type }}"
        
        # Add to websites list in README
        if grep -q "| Website | Type | Status |" README.md; then
          sed -i "/| Website | Type | Status |/a | **${DOMAIN}** | ${WEBSITE_TYPE^} | ðŸŸ¢ Ready |" README.md
        fi
        
    - name: ðŸ’¾ Commit changes
      run: |
        git add .
        git commit -m "feat: add ${{ inputs.domain }} (${{ inputs.website_type }}) website
        
        - Added Docker Compose service configuration
        - Created Nginx virtual host configuration
        - Generated website directory structure
        - Added environment variable templates
        - Created documentation
        
        Website Details:
        - Domain: ${{ inputs.domain }}
        - Type: ${{ inputs.website_type }}
        - Container: ${{ inputs.website_name }}-${{ inputs.website_type == 'wordpress' && 'wp' || 'static' }}
        
        Auto-generated by GitHub Actions"
        
    - name: ðŸ“¤ Push feature branch
      run: |
        git push origin $BRANCH_NAME
        
    - name: ðŸ”€ Create Pull Request
      uses: actions/github-script@v7
      with:
        script: |
          const { data: pullRequest } = await github.rest.pulls.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'ðŸ†• Add ${{ inputs.domain }} (${{ inputs.website_type }}) website',
            head: process.env.BRANCH_NAME,
            base: 'main',
            body: `## ðŸŒ New Website Addition
        
            **Domain:** ${{ inputs.domain }}
            **Type:** ${{ inputs.website_type }}
            **Container:** ${{ inputs.website_name }}-${{ inputs.website_type == 'wordpress' && 'wp' || 'static' }}
            **SSL:** ${{ inputs.ssl_enabled && 'âœ… Enabled' || 'âŒ Disabled' }}
            
            ### âœ… What was added:
            - [x] Docker Compose service configuration
            - [x] Nginx virtual host setup
            - [x] Website directory structure
            - [x] Environment variable templates
            - [x] Documentation in \`docs/websites/${{ inputs.website_name }}.md\`
            
            ### âš ï¸ Before merging:
            ${{ inputs.website_type == 'wordpress' && '- [ ] Add database credentials to `.env` file' || '- [x] No database setup needed' }}
            - [ ] Configure DNS records for ${{ inputs.domain }}
            - [ ] Verify domain points to server IP
            ${{ inputs.ssl_enabled && '- [ ] Generate SSL certificate after deployment' || '- [ ] SSL certificate not requested' }}
            
            ### ðŸš€ After merging:
            1. Update your \`.env\` file with the new environment variables
            2. Configure DNS: Point ${{ inputs.domain }} to your server IP
            3. Deploy: The website will be automatically deployed
            ${{ inputs.ssl_enabled && '4. Generate SSL: Run `certbot certonly --standalone -d ${{ inputs.domain }} -d www.${{ inputs.domain }}`' || '' }}
            
            ### ðŸ“‹ Environment Variables to Add:
            ${{ inputs.website_type == 'wordpress' && '\n```bash\n' + inputs.website_name.toUpperCase() + '_DB_NAME=' + inputs.website_name + '_wp\n' + inputs.website_name.toUpperCase() + '_DB_USER=' + inputs.website_name + '_user\n' + inputs.website_name.toUpperCase() + '_DB_PASSWORD=secure_password_here\n```' || 'No database configuration needed for static websites.' }}
            
            ---
            ðŸ¤– *This pull request was automatically generated by GitHub Actions*`
          });
          
          core.info(\`Pull request created: \${pullRequest.html_url}\`);
          
    - name: ðŸ“¨ Notify completion
      uses: 8398a7/action-slack@v3
      if: success()
      with:
        status: success
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        text: |
          ðŸ†• New website addition completed!
          
          **Domain:** ${{ inputs.domain }}
          **Type:** ${{ inputs.website_type }}
          **Pull Request:** Ready for review
          
          Next steps: Review and merge the auto-generated pull request.